<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actes de Décès - État Civil Tchad</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style id="common-styles"></style>
  <style>
    .page-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div id="sidebar-container"></div>
  
  <div class="main-content">
    <div class="page-container">
      
  <div class="container mt-5">
    <h2 id="pageTitle" class="mb-4"><i class="fas fa-skull me-2"></i> Enregistrer un Acte de Décès</h2>
    <form id="formDeces">
      <!-- Informations du défunt -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-user me-2"></i>Informations du défunt</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nom du défunt *</label>
                <input type="text" name="nom" class="form-control" required />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Prénom *</label>
                <input type="text" name="prenom" class="form-control" required />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Date de naissance</label>
                <input type="date" name="dateNaissance" class="form-control" />
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Lieu de naissance</label>
                <input type="text" name="lieuNaissance" class="form-control" placeholder="Ville, Pays" />
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Sexe *</label>
                <select name="sexe" class="form-select" required>
                  <option value="">Sélectionner</option>
                  <option value="M">Masculin</option>
                  <option value="F">Féminin</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nationalité</label>
                <input type="text" name="nationalite" class="form-control" value="Tchadienne" />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Profession</label>
                <input type="text" name="profession" class="form-control" />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div class="mb-3">
                <label class="form-label">Adresse de résidence</label>
                <textarea name="adresse" class="form-control" rows="2" placeholder="Adresse complète du défunt"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Informations du décès -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-calendar-times me-2"></i>Informations du décès</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Date de décès *</label>
                <input type="date" name="dateDeces" class="form-control" required />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Heure du décès</label>
                <input type="time" name="heureDeces" class="form-control" />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label class="form-label">Lieu de décès *</label>
                <input type="text" name="lieuDeces" class="form-control" placeholder="Hôpital, domicile, ville..." required />
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Âge au décès</label>
                <input type="number" name="age" class="form-control" min="0" max="150" />
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Cause du décès</label>
            <textarea name="cause" class="form-control" rows="3" placeholder="Cause médicale ou circonstances du décès"></textarea>
          </div>
        </div>
      </div>

      <!-- Informations familiales -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-users me-2"></i>Informations familiales</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nom du père</label>
                <input type="text" name="nomPere" class="form-control" />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nom de la mère</label>
                <input type="text" name="nomMere" class="form-control" />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Situation matrimoniale</label>
                <select name="situationMatrimoniale" class="form-select">
                  <option value="">Sélectionner</option>
                  <option value="Célibataire">Célibataire</option>
                  <option value="Marié(e)">Marié(e)</option>
                  <option value="Veuf/Veuve">Veuf/Veuve</option>
                  <option value="Divorcé(e)">Divorcé(e)</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nom du conjoint</label>
                <input type="text" name="nomConjoint" class="form-control" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Informations du déclarant -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Informations du déclarant</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Nom du déclarant *</label>
                <input type="text" name="nomDeclarant" class="form-control" required />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Prénom du déclarant *</label>
                <input type="text" name="prenomDeclarant" class="form-control" required />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Lien avec le défunt *</label>
                <select name="lienDeclarant" class="form-select" required>
                  <option value="">Sélectionner</option>
                  <option value="Conjoint">Conjoint</option>
                  <option value="Enfant">Enfant</option>
                  <option value="Parent">Parent</option>
                  <option value="Frère/Sœur">Frère/Sœur</option>
                  <option value="Ami/Proche">Ami/Proche</option>
                  <option value="Médecin">Médecin</option>
                  <option value="Autorité">Autorité</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Téléphone du déclarant</label>
                <input type="tel" name="telephoneDeclarant" class="form-control" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Informations administratives -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-building me-2"></i>Informations administratives</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Mairie d'enregistrement *</label>
                <input type="text" name="mairie" class="form-control" placeholder="Ex: Mairie d'abeche" required />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Date d'enregistrement</label>
                <input type="date" name="dateEnregistrement" class="form-control" value="" />
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Numéro de certificat médical</label>
                <input type="text" name="numeroCertificat" class="form-control" />
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">Médecin certificateur</label>
                <input type="text" name="medecinCertificateur" class="form-control" />
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Observations</label>
            <textarea name="observations" class="form-control" rows="3" placeholder="Remarques particulières ou informations complémentaires"></textarea>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-danger">
          <i class="fas fa-save me-2"></i>Enregistrer l'acte de décès
        </button>
        <a href="/dashboard" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-2"></i>Retour au tableau de bord
        </a>
      </div>
    </form>
    <div id="result" class="mt-3"></div>
  </div>
  

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/sidebar-template.js"></script>
  <script>
    let formHandler = null;
    let isEditMode = false;
    let editActeId = null;
    
    document.addEventListener('DOMContentLoaded', () => {
      const token = checkAuth();
      if (!token) return;
      
      document.getElementById('common-styles').textContent = commonCSS;
      document.getElementById('sidebar-container').innerHTML = createSidebar('deces');
      
      // Vérifier si on est en mode édition
      const urlParams = new URLSearchParams(window.location.search);
      editActeId = urlParams.get('edit');
      
      if (editActeId) {
        isEditMode = true;
        document.getElementById('pageTitle').innerHTML = '<i class="fas fa-edit me-2"></i> Modification d\'un Acte de Décès';
        loadActeForEdit(editActeId);
      }
      
      // Initialiser le gestionnaire de formulaire
      initializeFormHandler();
      
      // Définir la date d'enregistrement par défaut à aujourd'hui
      const dateEnregistrement = document.querySelector('input[name="dateEnregistrement"]');
      if (dateEnregistrement && !isEditMode) {
        dateEnregistrement.value = new Date().toISOString().split('T')[0];
      }
    });
    
    async function loadActeForEdit(acteId) {
      try {
        const response = await fetch(`/api/actes/${acteId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Erreur lors du chargement de l\'acte');
        }
        
        const result = await response.json();
        if (result.success && result.data) {
          populateForm(result.data);
        }
      } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors du chargement des données de l\'acte');
      }
    }
    
    function populateForm(acte) {
      const details = acte.details;
      
      // Informations du défunt
      if (details.nom) document.querySelector('input[name="nom"]').value = details.nom;
      if (details.prenom) document.querySelector('input[name="prenom"]').value = details.prenom;
      if (details.dateNaissance) document.querySelector('input[name="dateNaissance"]').value = details.dateNaissance.split('T')[0];
      if (details.lieuNaissance) document.querySelector('input[name="lieuNaissance"]').value = details.lieuNaissance;
      if (details.sexe) document.querySelector('select[name="sexe"]').value = details.sexe;
      if (details.nationalite) document.querySelector('input[name="nationalite"]').value = details.nationalite;
      if (details.profession) document.querySelector('input[name="profession"]').value = details.profession;
      if (details.adresse) document.querySelector('textarea[name="adresse"]').value = details.adresse;
      
      // Informations du décès
      if (details.dateDeces) document.querySelector('input[name="dateDeces"]').value = details.dateDeces.split('T')[0];
      if (details.heureDeces) document.querySelector('input[name="heureDeces"]').value = details.heureDeces;
      if (details.lieuDeces) document.querySelector('input[name="lieuDeces"]').value = details.lieuDeces;
      if (details.age) document.querySelector('input[name="age"]').value = details.age;
      if (details.cause) document.querySelector('textarea[name="cause"]').value = details.cause;
      
      // Informations familiales
      if (details.nomPere) document.querySelector('input[name="nomPere"]').value = details.nomPere;
      if (details.nomMere) document.querySelector('input[name="nomMere"]').value = details.nomMere;
      if (details.situationMatrimoniale) document.querySelector('select[name="situationMatrimoniale"]').value = details.situationMatrimoniale;
      if (details.nomConjoint) document.querySelector('input[name="nomConjoint"]').value = details.nomConjoint;
      
      // Informations du déclarant
      if (details.nomDeclarant) document.querySelector('input[name="nomDeclarant"]').value = details.nomDeclarant;
      if (details.prenomDeclarant) document.querySelector('input[name="prenomDeclarant"]').value = details.prenomDeclarant;
      if (details.lienDeclarant) document.querySelector('select[name="lienDeclarant"]').value = details.lienDeclarant;
      if (details.telephoneDeclarant) document.querySelector('input[name="telephoneDeclarant"]').value = details.telephoneDeclarant;
      
      // Informations administratives
      if (acte.mairie) document.querySelector('input[name="mairie"]').value = acte.mairie;
      if (acte.dateEnregistrement) document.querySelector('input[name="dateEnregistrement"]').value = acte.dateEnregistrement.split('T')[0];
      if (details.numeroCertificat) document.querySelector('input[name="numeroCertificat"]').value = details.numeroCertificat;
      if (details.medecinCertificateur) document.querySelector('input[name="medecinCertificateur"]').value = details.medecinCertificateur;
      if (details.observations) document.querySelector('textarea[name="observations"]').value = details.observations;
    }
    
    function showError(message) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Erreur !</strong> ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      resultDiv.scrollIntoView({ behavior: 'smooth' });
    }
    
    function initializeFormHandler() {
      const form = document.getElementById('formDeces');
      const resultDiv = document.getElementById('result');
      
      if (!form || !resultDiv) return;
      
      // Nettoyer les anciens event listeners
      if (formHandler) {
        form.removeEventListener('submit', formHandler);
      }
      
      // Créer le nouveau gestionnaire
      formHandler = async (e) => {
        e.preventDefault();
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        try {
          // Désactiver le bouton et afficher le loading
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enregistrement...';
          
          // Collecter les données du formulaire
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          
          // Validation côté client
          if (!validateDecesForm(data)) {
            throw new Error('Veuillez remplir tous les champs obligatoires');
          }
          
          // Préparer les données pour l'API
          const apiData = {
            type: 'deces',
            details: data,
            mairie: data.mairie
          };
          
          // Envoyer les données avec timeout
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
          
          const url = isEditMode ? `/api/actes/${editActeId}` : '/api/actes';
          const method = isEditMode ? 'PUT' : 'POST';
          
          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(apiData),
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Erreur lors de l\'enregistrement');
          }
          
          const result = await response.json();
          
          // Afficher le succès
          const successMessage = isEditMode ? 'L\'acte de décès a été modifié avec succès.' : 'L\'acte de décès a été enregistré avec succès.';
          resultDiv.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Succès !</strong> ${successMessage}
              <br><small>Numéro d'acte: ${result.data?.numeroActe || 'N/A'}</small>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          
          // En mode édition, ne pas réinitialiser le formulaire
          if (!isEditMode) {
            form.reset();
          }
          
          // Auto-scroll vers le résultat
          resultDiv.scrollIntoView({ behavior: 'smooth' });
          
        } catch (error) {
          console.error('Erreur:', error);
          
          let errorMessage = 'Une erreur est survenue lors de l\'enregistrement';
          if (error.name === 'AbortError') {
            errorMessage = 'La requête a pris trop de temps. Veuillez réessayer.';
          } else if (error.message) {
            errorMessage = error.message;
          }
          
          resultDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Erreur !</strong> ${errorMessage}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          `;
          
          resultDiv.scrollIntoView({ behavior: 'smooth' });
          
        } finally {
          // Restaurer le bouton
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      };
      
      // Attacher l'event listener
      form.addEventListener('submit', formHandler);
    }
    
    function validateDecesForm(data) {
      const required = ['nom', 'prenom', 'sexe', 'dateDeces', 'lieuDeces', 
                       'nomDeclarant', 'prenomDeclarant', 'lienDeclarant', 'mairie'];
      
      for (const field of required) {
        if (!data[field] || data[field].trim() === '') {
          return false;
        }
      }
      
      // Validation des dates
      if (data.dateDeces) {
        const dateDeces = new Date(data.dateDeces);
        const today = new Date();
        if (dateDeces > today) {
          return false; // Date de décès ne peut pas être dans le futur
        }
      }
      
      if (data.dateNaissance && data.dateDeces) {
        const dateNaissance = new Date(data.dateNaissance);
        const dateDeces = new Date(data.dateDeces);
        if (dateNaissance > dateDeces) {
          return false; // Date de naissance ne peut pas être après le décès
        }
      }
      
      return true;
    }
    
    // Nettoyage lors du déchargement de la page
    window.addEventListener('beforeunload', () => {
      const form = document.getElementById('formDeces');
      if (form && formHandler) {
        form.removeEventListener('submit', formHandler);
        formHandler = null;
      }
    });
  </script>
</body>
</html>