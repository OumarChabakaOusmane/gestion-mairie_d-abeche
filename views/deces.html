<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Actes de Décès - État Civil Tchad</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/js/sidebar-template.js"></script>
  
  <style id="common-styles">
    /* Styles de base - seront remplacés par commonCSS */
  </style>
  <style>
    body {
      min-height: 100vh;
      background-color: #f8f9fa;
    }
    
    .main-content {
      margin-left: 320px;
      padding: 20px;
    }
    
    .page-container {
      background: white;
      border-radius: 10px;
      padding: 40px 50px;
      margin: 20px auto;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      max-width: 1400px;
      font-size: 16px;
    }
    
    .form-section {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .form-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      position: relative;
    }
    
    .step {
      text-align: center;
      flex: 1;
      position: relative;
    }
    
    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e9ecef;
      color: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: 600;
      border: 2px solid #e9ecef;
      transition: all 0.3s;
    }
    
    .step.active .step-number {
      background: #0d6efd;
      color: white;
      border-color: #0d6efd;
    }
    
    .step.completed .step-number {
      background: #198754;
      color: white;
      border-color: #198754;
    }
    
    .step-text {
      font-size: 16px;
      color: #6c757d;
      font-weight: 500;
    }
    
    .step-number {
      width: 50px;
      height: 50px;
      font-size: 20px;
    }
    
    .step.active .step-text {
      color: #0d6efd;
    }
    
    .form-label {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }
    
    .form-label.required:after {
      content: ' *';
      color: #dc3545;
    }
    
    .form-control, .form-select {
      font-size: 16px;
      padding: 12px 15px;
      height: auto;
      min-height: 48px;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }
    
    h4 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    
    h1.h3 {
      font-size: 28px;
      font-weight: 700;
    }
    
    .form-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #eee;
    }
    
    .btn {
      font-size: 16px;
      padding: 12px 30px;
      font-weight: 600;
    }
    
    .btn-lg {
      font-size: 18px;
      padding: 15px 40px;
    }
    
    .row.g-3 {
      --bs-gutter-y: 1.5rem;
      --bs-gutter-x: 1.5rem;
    }
    
    .summary-card {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 20px;
    }
    
    .summary-card h5 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #dee2e6;
      font-size: 16px;
    }
    
    .summary-row:last-child {
      border-bottom: none;
    }
    
    .summary-label {
      font-weight: 600;
      color: #495057;
      font-size: 16px;
    }
    
    .summary-value {
      color: #212529;
      font-size: 16px;
    }
    
    .invalid-feedback {
      display: block;
      width: 100%;
      margin-top: 0.25rem;
      font-size: 0.875em;
      color: #dc3545;
    }
    
    .is-invalid {
      border-color: #dc3545;
    }
  </style>
</head>
<body>
  <div id="sidebar-container"></div>
  
  <div class="main-content">
    <div class="page-container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 mb-3"><i class="fas fa-skull me-2 text-primary"></i> Enregistrement d'un Acte de Décès</h1>
          <p class="text-muted mb-4" style="font-size: 18px;">Remplissez les informations requises pour enregistrer un nouvel acte de décès</p>
        </div>
      </div>
      
      <!-- Indicateur de progression -->
      <div class="step-indicator">
        <div class="step active" data-step="1">
          <div class="step-number">1</div>
          <div class="step-text">Défunt</div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-text">Décès</div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-text">Déclarant / Famille</div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-text">Validation</div>
        </div>
      </div>
      
      <form id="formDeces">
        <!-- PAGE 1: DÉFUNT -->
        <div class="form-section active" id="section-1">
          <h4 class="mb-4"><i class="fas fa-user me-2 text-primary"></i>Informations du défunt</h4>
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Nom</label>
              <input type="text" name="nom" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Prénom</label>
              <input type="text" name="prenom" class="form-control" required>
            </div>
            
            <div class="col-md-4">
              <label class="form-label required">Sexe</label>
              <select name="sexe" class="form-select" required>
                <option value="">Sélectionner</option>
                <option value="M">Masculin</option>
                <option value="F">Féminin</option>
              </select>
            </div>
            
            <div class="col-md-4">
              <label class="form-label required">Date de décès</label>
              <input type="date" name="dateDeces" class="form-control" required>
            </div>
            
            <div class="col-md-4">
              <label class="form-label required">Lieu de décès</label>
              <input type="text" name="lieuDeces" class="form-control" placeholder="Ex: N'Djamena, Tchad" required>
            </div>
            
            <div class="col-md-4">
              <label class="form-label">Âge</label>
              <div class="input-group">
                <input type="number" name="age" class="form-control" min="0" max="150" placeholder="Âge au décès">
                <span class="input-group-text">ans</span>
              </div>
            </div>
            
            <div class="col-md-4">
              <label class="form-label">Nationalité</label>
              <select name="nationalite" class="form-select">
                <option value="Tchadienne" selected>Tchadienne</option>
                <option value="Étrangère">Étrangère</option>
              </select>
            </div>
            
            <div class="col-md-4">
              <label class="form-label">Adresse</label>
              <input type="text" name="adresse" class="form-control" placeholder="Dernière adresse connue">
            </div>
          </div>
          
          <div class="form-actions">
            <div></div>
            <button type="button" class="btn btn-primary" onclick="nextStep(2)">
              Suivant <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- PAGE 2: DÉCÈS -->
        <div class="form-section" id="section-2">
          <h4 class="mb-4"><i class="fas fa-calendar-times me-2 text-primary"></i>Informations du décès</h4>
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Date du décès</label>
              <input type="date" name="dateDeces2" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Heure du décès</label>
              <input type="time" name="heureDeces" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Lieu du décès</label>
              <input type="text" name="lieuDeces2" class="form-control" placeholder="Adresse ou établissement" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Cause du décès</label>
              <input type="text" name="causeDeces" class="form-control" placeholder="Cause (optionnel)">
            </div>
            
            <div class="col-md-12">
              <label class="form-label required">Centre d'état civil</label>
              <input type="text" name="centreEtatCivil" class="form-control" placeholder="Ex: Mairie de N'Djamena 1er Arrondissement" required>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-outline-secondary" onclick="previousStep(1)">
              <i class="fas fa-arrow-left me-2"></i> Précédent
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep(3)">
              Suivant <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- PAGE 3: DÉCLARANT / FAMILLE -->
        <div class="form-section" id="section-3">
          <h4 class="mb-4"><i class="fas fa-users me-2 text-primary"></i>Déclarant et famille</h4>
          
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label required">Nom du déclarant</label>
              <input type="text" name="nomDeclarant" class="form-control" required>
            </div>
            
            <div class="col-md-6">
              <label class="form-label required">Lien avec le défunt</label>
              <select name="lienDeclarant" class="form-select" required>
                <option value="">Sélectionner</option>
                <option value="Conjoint(e)">Conjoint(e)</option>
                <option value="Enfant">Enfant</option>
                <option value="Parent">Parent</option>
                <option value="Frère/Sœur">Frère/Sœur</option>
                <option value="Autre membre de la famille">Autre membre de la famille</option>
                <option value="Autre">Autre</option>
              </select>
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Situation matrimoniale</label>
              <select name="situationMatrimoniale" class="form-select">
                <option value="">Sélectionner</option>
                <option value="Célibataire">Célibataire</option>
                <option value="Marié(e)">Marié(e)</option>
                <option value="Veuf/Veuve">Veuf/Veuve</option>
                <option value="Séparé(e)">Séparé(e)</option>
              </select>
            </div>
            
            <div class="col-md-6" id="conjointField" style="display: none;">
              <label class="form-label">Nom du conjoint</label>
              <input type="text" name="nomConjoint" class="form-control" placeholder="Nom et prénom du conjoint">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Nom du père</label>
              <input type="text" name="nomPere" class="form-control" placeholder="Nom et prénom du père">
            </div>
            
            <div class="col-md-6">
              <label class="form-label">Nom de la mère</label>
              <input type="text" name="nomMere" class="form-control" placeholder="Nom et prénom de la mère">
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-outline-secondary" onclick="previousStep(2)">
              <i class="fas fa-arrow-left me-2"></i> Précédent
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep(4)">
              Suivant <i class="fas fa-arrow-right ms-2"></i>
            </button>
          </div>
        </div>
        
        <!-- PAGE 4: VALIDATION -->
        <div class="form-section" id="section-4">
          <h4 class="mb-4"><i class="fas fa-check-circle me-2 text-primary"></i>Récapitulatif et validation</h4>
          
          <div id="summaryContent">
            <!-- Le récapitulatif sera généré dynamiquement -->
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-outline-secondary" onclick="previousStep(3)">
              <i class="fas fa-arrow-left me-2"></i> Précédent
            </button>
            <button type="button" class="btn btn-success btn-lg" onclick="submitForm()">
              <i class="fas fa-save me-2"></i> ENREGISTRER
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Variables globales
    let currentStep = 1;
    const totalSteps = 4;
    
    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
      // Vérifier l'authentification
      const token = checkAuth();
      if (!token) {
        window.location.href = '/login';
        return;
      }
      
      // Injecter le CSS commun
      if (typeof commonCSS !== 'undefined') {
        document.getElementById('common-styles').textContent = commonCSS;
      }
      
      // Initialiser la sidebar
      if (typeof createSidebar === 'function') {
        document.getElementById('sidebar-container').innerHTML = createSidebar('deces');
      } else {
        // Attendre que le script soit chargé
        setTimeout(() => {
          if (typeof createSidebar === 'function') {
            document.getElementById('sidebar-container').innerHTML = createSidebar('deces');
            if (typeof commonCSS !== 'undefined') {
              document.getElementById('common-styles').textContent = commonCSS;
            }
          }
        }, 100);
      }
      
      // Gérer l'affichage du champ conjoint
      const situationSelect = document.querySelector('select[name="situationMatrimoniale"]');
      const conjointField = document.getElementById('conjointField');
      
      if (situationSelect && conjointField) {
        situationSelect.addEventListener('change', function() {
          if (this.value === 'Marié(e)') {
            conjointField.style.display = 'block';
          } else {
            conjointField.style.display = 'none';
            document.querySelector('input[name="nomConjoint"]').value = '';
          }
        });
      }
      
      // Synchroniser les champs dateDeces
      const dateDeces1 = document.querySelector('input[name="dateDeces"]');
      const dateDeces2 = document.querySelector('input[name="dateDeces2"]');
      const lieuDeces1 = document.querySelector('input[name="lieuDeces"]');
      const lieuDeces2 = document.querySelector('input[name="lieuDeces2"]');
      
      if (dateDeces1 && dateDeces2) {
        dateDeces1.addEventListener('change', function() {
          dateDeces2.value = this.value;
        });
        dateDeces2.addEventListener('change', function() {
          dateDeces1.value = this.value;
        });
      }
      
      if (lieuDeces1 && lieuDeces2) {
        lieuDeces1.addEventListener('change', function() {
          lieuDeces2.value = this.value;
        });
        lieuDeces2.addEventListener('change', function() {
          lieuDeces1.value = this.value;
        });
      }
    });
    
    
    // Fonction pour valider une étape
    function validateStep(step) {
      const section = document.getElementById(`section-${step}`);
      const requiredFields = section.querySelectorAll('[required]');
      let isValid = true;
      
      // Nettoyer les erreurs précédentes
      section.querySelectorAll('.is-invalid').forEach(field => {
        field.classList.remove('is-invalid');
      });
      section.querySelectorAll('.invalid-feedback').forEach(feedback => {
        feedback.remove();
      });
      
      // Valider les champs requis
      requiredFields.forEach(field => {
        if (!field.value || (field.value.trim && field.value.trim() === '')) {
          isValid = false;
          field.classList.add('is-invalid');
          const feedback = document.createElement('div');
          feedback.className = 'invalid-feedback';
          feedback.textContent = 'Ce champ est obligatoire';
          field.parentNode.appendChild(feedback);
        }
      });
      
      // Validation spécifique pour la date de décès
      if (step === 1 || step === 2) {
        const dateDeces = document.querySelector('input[name="dateDeces"]').value || 
                         document.querySelector('input[name="dateDeces2"]').value;
        if (dateDeces) {
          const date = new Date(dateDeces);
          const today = new Date();
          if (date > today) {
            isValid = false;
            Swal.fire({
              icon: 'error',
              title: 'Erreur',
              text: 'La date de décès ne peut pas être dans le futur'
            });
          }
        }
      }
      
      if (!isValid) {
        Swal.fire({
          icon: 'error',
          title: 'Champs manquants',
          text: 'Veuillez remplir tous les champs obligatoires'
        });
      }
      
      return isValid;
    }
    
    // Fonction pour passer à l'étape suivante
    function nextStep(step) {
      if (step > 1 && !validateStep(step - 1)) {
        return;
      }
      
      // Si on passe à l'étape 4, générer le récapitulatif
      if (step === 4) {
        generateSummary();
      }
      
      // Masquer toutes les sections
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Afficher la section demandée
      document.getElementById(`section-${step}`).classList.add('active');
      
      // Mettre à jour les indicateurs d'étape
      document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) {
          stepEl.classList.add('completed');
        } else if (index + 1 === step) {
          stepEl.classList.add('active');
        }
      });
      
      currentStep = step;
      
      // Faire défiler vers le haut
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Fonction pour revenir à l'étape précédente
    function previousStep(step) {
      nextStep(step);
    }
    
    // Fonction pour générer le récapitulatif
    function generateSummary() {
      const form = document.getElementById('formDeces');
      const formData = new FormData(form);
      const data = {};
      
      for (let [key, value] of formData.entries()) {
        if (key !== 'dateDeces2' && key !== 'lieuDeces2') {
          data[key] = value;
        }
      }
      
      const summary = document.getElementById('summaryContent');
      summary.innerHTML = `
        <div class="summary-card">
          <h5 class="mb-3"><i class="fas fa-user me-2"></i>Informations du défunt</h5>
          <div class="summary-row">
            <span class="summary-label">Nom :</span>
            <span class="summary-value">${data.nom || 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Prénom :</span>
            <span class="summary-value">${data.prenom || 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Sexe :</span>
            <span class="summary-value">${data.sexe === 'M' ? 'Masculin' : data.sexe === 'F' ? 'Féminin' : 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Date de décès :</span>
            <span class="summary-value">${data.dateDeces ? new Date(data.dateDeces).toLocaleDateString('fr-FR') : 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Lieu de décès :</span>
            <span class="summary-value">${data.lieuDeces || 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Âge :</span>
            <span class="summary-value">${data.age ? data.age + ' ans' : 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Nationalité :</span>
            <span class="summary-value">${data.nationalite || 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Adresse :</span>
            <span class="summary-value">${data.adresse || 'Non renseigné'}</span>
          </div>
        </div>
        
        <div class="summary-card">
          <h5 class="mb-3"><i class="fas fa-calendar-times me-2"></i>Informations du décès</h5>
          <div class="summary-row">
            <span class="summary-label">Heure du décès :</span>
            <span class="summary-value">${data.heureDeces || 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Cause :</span>
            <span class="summary-value">${data.causeDeces || 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Centre d'état civil :</span>
            <span class="summary-value">${data.centreEtatCivil || 'Non renseigné'}</span>
          </div>
        </div>
        
        <div class="summary-card">
          <h5 class="mb-3"><i class="fas fa-users me-2"></i>Déclarant et famille</h5>
          <div class="summary-row">
            <span class="summary-label">Nom du déclarant :</span>
            <span class="summary-value">${data.nomDeclarant || 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Lien avec le défunt :</span>
            <span class="summary-value">${data.lienDeclarant || 'Non renseigné'}</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Situation matrimoniale :</span>
            <span class="summary-value">${data.situationMatrimoniale || 'Non renseigné'}</span>
          </div>
          ${data.nomConjoint ? `
          <div class="summary-row">
            <span class="summary-label">Conjoint :</span>
            <span class="summary-value">${data.nomConjoint}</span>
          </div>
          ` : ''}
          ${data.nomPere ? `
          <div class="summary-row">
            <span class="summary-label">Père :</span>
            <span class="summary-value">${data.nomPere}</span>
          </div>
          ` : ''}
          ${data.nomMere ? `
          <div class="summary-row">
            <span class="summary-label">Mère :</span>
            <span class="summary-value">${data.nomMere}</span>
          </div>
          ` : ''}
        </div>
      `;
    }
    
    // Fonction pour soumettre le formulaire
    async function submitForm() {
      // Valider l'étape 4
      if (!validateStep(4)) {
        return;
      }
      
      // Récupérer les données du formulaire
      const form = document.getElementById('formDeces');
      const formData = new FormData(form);
      const data = {};
      
      for (let [key, value] of formData.entries()) {
        // Ignorer les champs dupliqués
        if (key !== 'dateDeces2' && key !== 'lieuDeces2') {
          data[key] = value;
        }
      }
      
      // Préparer les données pour l'API
      const acteData = {
        type: 'deces',
        details: {
          nom: data.nom,
          prenom: data.prenom,
          sexe: data.sexe,
          dateDeces: data.dateDeces,
          heureDeces: data.heureDeces,
          lieuDeces: data.lieuDeces,
          age: data.age ? parseInt(data.age) : null,
          nationalite: data.nationalite,
          adresse: data.adresse,
          causeDeces: data.causeDeces || null,
          centreEtatCivil: data.centreEtatCivil,
          nomDeclarant: data.nomDeclarant,
          lienDeclarant: data.lienDeclarant,
          situationMatrimoniale: data.situationMatrimoniale,
          nomConjoint: data.nomConjoint || null,
          pere: data.nomPere || null,
          mere: data.nomMere || null
        },
        mairie: data.centreEtatCivil
      };
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/actes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(acteData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Succès !',
            text: 'L\'acte de décès a été enregistré avec succès',
            confirmButtonText: 'OK'
          }).then(() => {
            window.location.href = '/deces';
          });
        } else {
          throw new Error(result.error || 'Erreur lors de l\'enregistrement');
        }
      } catch (error) {
        console.error('Erreur:', error);
        Swal.fire({
          icon: 'error',
          title: 'Erreur',
          text: error.message || 'Une erreur est survenue lors de l\'enregistrement'
        });
      }
    }
  </script>
</body>
</html>
