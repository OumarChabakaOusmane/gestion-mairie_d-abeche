<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Mairie d'Abéché</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .required:after {
            content: " *";
            color: red;
        }
        .form-title {
            color: #0d6efd;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <a href="/divorces" class="btn btn-sm btn-outline-light me-2">
                                <i class="fas fa-arrow-left me-1"></i> Retour
                            </a>
                            <span class="h4 mb-0">Formulaire d'Acte de Divorce</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="divorceForm" class="needs-validation" novalidate>
                            <!-- Token CSRF -->
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            
                            <!-- Informations sur le divorce -->
                            <div class="form-section mb-4">
                                <h4 class="form-title">Informations sur le divorce</h4>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="numeroActe" class="form-label required">Numéro d'acte</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="numeroActe" required 
                                                value="" readonly>
                                            <button type="button" class="btn btn-outline-secondary" id="editNumeroActe">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="dateDivorce" class="form-label required">Date du divorce</label>
                                        <input type="date" class="form-control" id="dateDivorce" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="dateMariage" class="form-label required">Date du mariage</label>
                                        <input type="date" class="form-control" id="dateMariage" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lieuMariage" class="form-label required">Lieu du mariage</label>
                                        <input type="text" class="form-control" id="lieuMariage" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="regimeMatrimonial" class="form-label required">Régime matrimonial</label>
                                        <select class="form-select" id="regimeMatrimonial" required>
                                            <option value="">Sélectionnez un régime</option>
                                            <option value="communauté réduite aux acquêts">Communauté réduite aux acquêts</option>
                                            <option value="séparation de biens">Séparation de biens</option>
                                            <option value="communauté universelle">Communauté universelle</option>
                                            <option value="participation aux acquêts">Participation aux acquêts</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Informations sur l'époux -->
                            <div class="form-section mb-4">
                                <h4 class="form-title">Informations sur l'époux</h4>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="epoux_nom" class="form-label required">Nom</label>
                                        <input type="text" class="form-control" id="epoux_nom" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epoux_prenom" class="form-label required">Prénom</label>
                                        <input type="text" class="form-control" id="epoux_prenom" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epoux_dateNaissance" class="form-label required">Date de naissance</label>
                                        <input type="date" class="form-control" id="epoux_dateNaissance" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="epoux_lieuNaissance" class="form-label required">Lieu de naissance</label>
                                        <input type="text" class="form-control" id="epoux_lieuNaissance" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="epoux_profession" class="form-label">Profession</label>
                                        <input type="text" class="form-control" id="epoux_profession">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="epoux_adresse" class="form-label">Adresse</label>
                                        <input type="text" class="form-control" id="epoux_adresse">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="epoux_nationalite" class="form-label">Nationalité</label>
                                        <input type="text" class="form-control" id="epoux_nationalite" value="Tchadienne">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epoux_typePiece" class="form-label">Type de pièce</label>
                                        <select class="form-select" id="epoux_typePiece">
                                            <option value="CNI">Carte nationale d'identité</option>
                                            <option value="Passeport">Passeport</option>
                                            <option value="Acte de naissance">Acte de naissance</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epoux_numeroPiece" class="form-label">N° de pièce</label>
                                        <input type="text" class="form-control" id="epoux_numeroPiece">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epoux_dateDelivrance" class="form-label">Date de délivrance</label>
                                        <input type="date" class="form-control" id="epoux_dateDelivrance">
                                    </div>
                                </div>
                            </div>

                            <!-- Informations sur l'épouse -->
                            <div class="form-section mb-4">
                                <h4 class="form-title">Informations sur l'épouse</h4>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="epouse_nom" class="form-label required">Nom de jeune fille</label>
                                        <input type="text" class="form-control" id="epouse_nom" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epouse_prenom" class="form-label required">Prénom</label>
                                        <input type="text" class="form-control" id="epouse_prenom" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epouse_dateNaissance" class="form-label required">Date de naissance</label>
                                        <input type="date" class="form-control" id="epouse_dateNaissance" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="epouse_lieuNaissance" class="form-label required">Lieu de naissance</label>
                                        <input type="text" class="form-control" id="epouse_lieuNaissance" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="epouse_profession" class="form-label">Profession</label>
                                        <input type="text" class="form-control" id="epouse_profession">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="epouse_adresse" class="form-label">Adresse</label>
                                        <input type="text" class="form-control" id="epouse_adresse">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="epouse_nationalite" class="form-label">Nationalité</label>
                                        <input type="text" class="form-control" id="epouse_nationalite" value="Tchadienne">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epouse_typePiece" class="form-label">Type de pièce</label>
                                        <select class="form-select" id="epouse_typePiece">
                                            <option value="CNI">Carte nationale d'identité</option>
                                            <option value="Passeport">Passeport</option>
                                            <option value="Acte de naissance">Acte de naissance</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epouse_numeroPiece" class="form-label">N° de pièce</label>
                                        <input type="text" class="form-control" id="epouse_numeroPiece">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="epouse_dateDelivrance" class="form-label">Date de délivrance</label>
                                        <input type="date" class="form-control" id="epouse_dateDelivrance">
                                    </div>
                                </div>
                            </div>

                            <!-- Motif du divorce -->
                            <div class="form-section mb-4">
                                <h4 class="form-title">Motif du divorce</h4>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="motifDivorce" id="divorceConsentementMutuel" value="consentement mutuel" checked>
                                        <label class="form-check-label" for="divorceConsentementMutuel">
                                            Consentement mutuel
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="motifDivorce" id="divorceFaute" value="pour faute">
                                        <label class="form-check-label" for="divorceFaute">
                                            Pour faute
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="motifDivorce" id="divorceAlteration" value="pour altération définitive du lien conjugal">
                                        <label class="form-check-label" for="divorceAlteration">
                                            Pour altération définitive du lien conjugal
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="motifs" class="form-label required">Détail des motifs</label>
                                    <textarea class="form-control" id="motifs" rows="3" required></textarea>
                                </div>
                            </div>

                            <!-- Enfants -->
                            <div class="form-section mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="form-title mb-0">Enfants mineurs</h4>
                                    <button type="button" class="btn btn-sm btn-primary" id="ajouterEnfant">
                                        <i class="fas fa-plus me-1"></i> Ajouter un enfant
                                    </button>
                                </div>
                                <div id="listeEnfants">
                                    <!-- Les champs pour les enfants seront ajoutés ici dynamiquement -->
                                </div>
                            </div>

                            <!-- Boutons d'action -->
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary" id="annulerBtn">
                                    <i class="fas fa-times me-1"></i> Annuler
                                </button>
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" id="enregistrerBrouillonBtn">
                                        <i class="fas fa-save me-1"></i> Enregistrer en brouillon
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-check me-1"></i> Valider l'acte
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // Générer un numéro d'acte automatique
            function genererNumeroActe() {
                const date = new Date();
                const annee = date.getFullYear();
                const numero = Math.floor(1000 + Math.random() * 9000);
                return `DIV-${annee}-${numero}`;
            }

            // Initialiser le numéro d'acte
            $('#numeroActe').val(genererNumeroActe());

            // Activer/désactiver l'édition du numéro d'acte
            $('#editNumeroActe').click(function() {
                const input = $('#numeroActe');
                if (input.prop('readonly')) {
                    input.prop('readonly', false).addClass('border-primary');
                    $(this).html('<i class="fas fa-check"></i>');
                } else {
                    input.prop('readonly', true).removeClass('border-primary');
                    $(this).html('<i class="fas fa-edit"></i>');
                }
            });

            // Gestion de l'ajout d'enfants
            let compteurEnfants = 0;
            
            $('#ajouterEnfant').click(function() {
                compteurEnfants++;
                const nouvelEnfant = `
                    <div class="card mb-3" id="enfant-${compteurEnfants}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Enfant ${compteurEnfants}</h5>
                                <button type="button" class="btn-close supprimer-enfant" data-id="${compteurEnfants}"></button>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Nom</label>
                                    <input type="text" class="form-control" name="enfants[${compteurEnfants}][nom]">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Prénom</label>
                                    <input type="text" class="form-control" name="enfants[${compteurEnfants}][prenom]">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Date de naissance</label>
                                    <input type="date" class="form-control" name="enfants[${compteurEnfants}][dateNaissance]">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Garde</label>
                                    <select class="form-select" name="enfants[${compteurEnfants}][garde]">
                                        <option value="père">Père</option>
                                        <option value="mère">Mère</option>
                                        <option value="garde alternée">Garde alternée</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                $('#listeEnfants').append(nouvelEnfant);
            });

            // Gestion de la suppression d'un enfant
            $(document).on('click', '.supprimer-enfant', function() {
                const id = $(this).data('id');
                $(`#enfant-${id}`).remove();
                // Réorganiser les numéros des enfants restants
                $('.card', '#listeEnfants').each(function(index) {
                    $(this).find('h5').text(`Enfant ${index + 1}`);
                });
            });

            // Récupérer le token CSRF
            function getCSRFToken() {
                return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            }

            // Récupérer le token d'authentification
            function getAuthToken() {
                return localStorage.getItem('token') || '';
            }

            // Préparer les données du formulaire
            function prepareFormData() {
                const formData = {
                    numeroActe: $('#numeroActe').val(),
                    dateDivorce: $('#dateDivorce').val(),
                    typeDivorce: $('input[name="motifDivorce"]:checked').val(),
                    motifs: $('#motifs').val(),
                    epoux: {
                        nom: $('#epoux_nom').val(),
                        prenoms: $('#epoux_prenom').val(),
                        dateNaissance: $('#epoux_dateNaissance').val(),
                        lieuNaissance: $('#epoux_lieuNaissance').val(),
                        profession: $('#epoux_profession').val(),
                        adresse: $('#epoux_adresse').val(),
                        nationalite: $('#epoux_nationalite').val(),
                        typePieceIdentite: $('#epoux_typePiece').val(),
                        numeroPieceIdentite: $('#epoux_numeroPiece').val(),
                        dateDelivrancePiece: $('#epoux_dateDelivrance').val(),
                        lieuDelivrancePiece: $('#epoux_lieuDelivrance').val()
                    },
                    epouse: {
                        nom: $('#epouse_nom').val(),
                        prenoms: $('#epouse_prenom').val(),
                        dateNaissance: $('#epouse_dateNaissance').val(),
                        lieuNaissance: $('#epouse_lieuNaissance').val(),
                        profession: $('#epouse_profession').val(),
                        adresse: $('#epouse_adresse').val(),
                        nationalite: $('#epouse_nationalite').val(),
                        typePieceIdentite: $('#epouse_typePiece').val(),
                        numeroPieceIdentite: $('#epouse_numeroPiece').val(),
                        dateDelivrancePiece: $('#epouse_dateDelivrance').val(),
                        lieuDelivrancePiece: $('#epouse_lieuDelivrance').val()
                    },
                    dateMariage: $('#dateMariage').val(),
                    lieuMariage: $('#lieuMariage').val(),
                    regimeMatrimonial: $('#regimeMatrimonial').val(),
                    dateEtablissement: new Date().toISOString(),
                    lieuEtablissement: 'Mairie d\'Abéché, Tchad',
                    officierEtatCivil: 'Officier d\'état civil',
                    gardeEnfants: []
                };

                // Ajouter les enfants
                $('.card', '#listeEnfants').each(function() {
                    const $card = $(this);
                    const enfant = {
                        nom: $card.find('input[name$="[nom]"]').val(),
                        prenom: $card.find('input[name$="[prenom]"]').val(),
                        dateNaissance: $card.find('input[name$="[dateNaissance]"]').val(),
                        garde: $card.find('select[name$="[garde]"]').val()
                    };
                    if (enfant.nom && enfant.prenom) {
                        formData.gardeEnfants.push(enfant);
                    }
                });

                return formData;
            }

            // Validation du formulaire
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    try {
                        const formData = prepareFormData();
                        console.log('Données du formulaire:', formData);

                        const response = await fetch('/api/divorces', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${getAuthToken()}`,
                                'X-CSRF-TOKEN': getCSRFToken()
                            },
                            body: JSON.stringify(formData)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            alert('Acte de divorce enregistré avec succès !');
                            window.location.href = '/divorces';
                        } else {
                            console.error('Erreur lors de l\'enregistrement:', data);
                            alert(`Erreur: ${data.message || 'Une erreur est survenue lors de l\'enregistrement'}`);
                        }
                    } catch (error) {
                        console.error('Erreur:', error);
                        alert('Une erreur est survenue lors de l\'envoi du formulaire');
                    }
                }, false);
            });

            // Annuler le formulaire
            $('#annulerBtn').click(function() {
                if (confirm('Voulez-vous vraiment annuler ? Toutes les modifications seront perdues.')) {
                    window.location.href = '/divorces';
                }
            });

            // Enregistrer en brouillon
            $('#enregistrerBrouillonBtn').click(function() {
                const formData = prepareFormData();
                formData.statut = 'brouillon';
                
                fetch('/api/divorces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'X-CSRF-TOKEN': getCSRFToken()
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Brouillon enregistré avec succès !');
                        window.location.href = '/divorces';
                    } else {
                        console.error('Erreur lors de l\'enregistrement du brouillon:', data);
                        alert('Erreur lors de l\'enregistrement du brouillon');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Une erreur est survenue lors de l\'enregistrement du brouillon');
                });
            });
        });
    </script>
</body>
</html>
