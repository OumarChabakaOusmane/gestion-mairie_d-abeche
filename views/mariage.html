<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Actes de Mariage - État Civil Tchad</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style id="common-styles"></style>
  <style>
    .form-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 2.5rem;
      margin-top: 2rem;
    }
    
    .form-header {
      border-bottom: 3px solid #e74c3c;
      padding-bottom: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
    }
    
    .form-icon {
      font-size: 3rem;
      color: #e74c3c;
      margin-bottom: 1rem;
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }
    
    .step {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #dee2e6;
      color: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .step.active {
      background: #e74c3c;
      color: white;
    }
    
    .step.completed {
      background: #28a745;
      color: white;
    }
    
    .form-section {
      display: none;
      animation: fadeIn 0.5s;
    }
    
    .form-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .btn-step {
      border-radius: 25px;
      padding: 10px 25px;
      font-weight: 600;
    }
    
    .witness-card {
      border: 2px dashed #dee2e6;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      transition: border-color 0.3s;
    }
    
    .witness-card:hover {
      border-color: #e74c3c;
    }
  </style>
</head>
<body>
  <div id="sidebar-container"></div>
  
  <div class="main-content">
    <div class="container" style="max-width: 1200px;">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="form-container">
            <div class="form-header">
              <i class="fas fa-heart form-icon"></i>
              <h2 class="mb-0">Enregistrement d'un Acte de Mariage</h2>
              <p class="text-muted mt-2">Union civile officielle</p>
            </div>
            
            <!-- Indicateur d'étapes -->
            <div class="step-indicator">
              <div class="step active" id="step-1">1</div>
              <div class="step" id="step-2">2</div>
              <div class="step" id="step-3">3</div>
              <div class="step" id="step-4">4</div>
            </div>
            
            <form id="formMariage">
              <!-- Étape 1: Informations générales -->
              <div class="form-section active" id="section-1">
                <h4 class="mb-4"><i class="fas fa-info-circle me-2"></i>Informations générales</h4>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Date du mariage *</label>
                    <input type="date" name="dateMariage" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Heure de la cérémonie</label>
                    <input type="time" name="heureMariage" class="form-control">
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Lieu du mariage *</label>
                    <input type="text" name="lieuMariage" class="form-control" placeholder="Ex: Église Sainte-Marie, N'Djaména" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Type de cérémonie</label>
                    <select name="typeCeremonie" class="form-select">
                      <option value="civile">Civile</option>
                      <option value="religieuse">Religieuse</option>
                      <option value="mixte">Civile et Religieuse</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Mairie d'enregistrement *</label>
                    <input type="text" name="mairie" class="form-control" placeholder="Ex: Mairie de N'Djaména 1er Arrondissement" required>
                  </div>
                </div>
              </div>
              
              <!-- Étape 2: Premier conjoint -->
              <div class="form-section" id="section-2">
                <h4 class="mb-4"><i class="fas fa-user me-2"></i>Premier conjoint</h4>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Nom de famille *</label>
                    <input type="text" name="nomConjoint1" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Prénom(s) *</label>
                    <input type="text" name="prenomConjoint1" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Date de naissance *</label>
                    <input type="date" name="dateNaissanceConjoint1" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Lieu de naissance *</label>
                    <input type="text" name="lieuNaissanceConjoint1" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Nationalité</label>
                    <input type="text" name="nationaliteConjoint1" class="form-control" value="Tchadienne">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Profession</label>
                    <input type="text" name="professionConjoint1" class="form-control">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Situation matrimoniale antérieure</label>
                    <select name="situationAnterieure1" class="form-select">
                      <option value="celibataire">Célibataire</option>
                      <option value="divorce">Divorcé(e)</option>
                      <option value="veuf">Veuf/Veuve</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Adresse complète</label>
                    <textarea name="adresseConjoint1" class="form-control" rows="2" placeholder="Rue, Quartier, Ville"></textarea>
                  </div>
                  <h6 class="mt-3">Parents du premier conjoint</h6>
                  <div class="col-md-6">
                    <label class="form-label">Nom et prénom du père</label>
                    <input type="text" name="pereConjoint1" class="form-control">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Nom et prénom de la mère</label>
                    <input type="text" name="mereConjoint1" class="form-control">
                  </div>
                </div>
              </div>
              
              <!-- Étape 3: Deuxième conjoint -->
              <div class="form-section" id="section-3">
                <h4 class="mb-4"><i class="fas fa-user me-2"></i>Deuxième conjoint</h4>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Nom de famille *</label>
                    <input type="text" name="nomConjoint2" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Prénom(s) *</label>
                    <input type="text" name="prenomConjoint2" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Date de naissance *</label>
                    <input type="date" name="dateNaissanceConjoint2" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Lieu de naissance *</label>
                    <input type="text" name="lieuNaissanceConjoint2" class="form-control" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Nationalité</label>
                    <input type="text" name="nationaliteConjoint2" class="form-control" value="Tchadienne">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Profession</label>
                    <input type="text" name="professionConjoint2" class="form-control">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Situation matrimoniale antérieure</label>
                    <select name="situationAnterieure2" class="form-select">
                      <option value="celibataire">Célibataire</option>
                      <option value="divorce">Divorcé(e)</option>
                      <option value="veuf">Veuf/Veuve</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Adresse complète</label>
                    <textarea name="adresseConjoint2" class="form-control" rows="2" placeholder="Rue, Quartier, Ville"></textarea>
                  </div>
                  <h6 class="mt-3">Parents du deuxième conjoint</h6>
                  <div class="col-md-6">
                    <label class="form-label">Nom et prénom du père</label>
                    <input type="text" name="pereConjoint2" class="form-control">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Nom et prénom de la mère</label>
                    <input type="text" name="mereConjoint2" class="form-control">
                  </div>
                </div>
              </div>
              
              <!-- Étape 4: Témoins -->
              <div class="form-section" id="section-4">
                <h4 class="mb-4"><i class="fas fa-users me-2"></i>Témoins</h4>
                
                <div class="witness-card">
                  <h6><i class="fas fa-user-tie me-2"></i>Premier témoin</h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Nom et prénom *</label>
                      <input type="text" name="temoin1" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Profession</label>
                      <input type="text" name="professionTemoin1" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Date de naissance</label>
                      <input type="date" name="dateNaissanceTemoin1" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Lieu de résidence</label>
                      <input type="text" name="residenceTemoin1" class="form-control">
                    </div>
                  </div>
                </div>
                
                <div class="witness-card">
                  <h6><i class="fas fa-user-tie me-2"></i>Deuxième témoin</h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Nom et prénom *</label>
                      <input type="text" name="temoin2" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Profession</label>
                      <input type="text" name="professionTemoin2" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Date de naissance</label>
                      <input type="date" name="dateNaissanceTemoin2" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Lieu de résidence</label>
                      <input type="text" name="residenceTemoin2" class="form-control">
                    </div>
                  </div>
                </div>
                
                <div class="mt-4">
                  <h6>Informations complémentaires</h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Régime matrimonial</label>
                      <select name="regimeMatrimonial" class="form-select">
                        <option value="communaute">Communauté de biens</option>
                        <option value="separation">Séparation de biens</option>
                        <option value="participation">Participation aux acquêts</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Contrat de mariage</label>
                      <select name="contratMariage" class="form-select">
                        <option value="non">Aucun</option>
                        <option value="oui">Contrat notarié</option>
                      </select>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Observations</label>
                      <textarea name="observations" class="form-control" rows="3" placeholder="Remarques particulières..."></textarea>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Boutons de navigation -->
              <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary btn-step" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                  <i class="fas fa-arrow-left me-2"></i>Précédent
                </button>
                <div class="ms-auto">
                  <button type="button" class="btn btn-primary btn-step" id="nextBtn" onclick="changeStep(1)">
                    Suivant<i class="fas fa-arrow-right ms-2"></i>
                  </button>
                  <button type="submit" class="btn btn-success btn-step" id="submitBtn" style="display: none;">
                    <i class="fas fa-save me-2"></i>Enregistrer l'acte
                  </button>
                </div>
              </div>
            </form>
            
            <div id="result" class="mt-4">
              <div id="success-message" class="alert alert-success d-none" role="alert">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="success-text"></span>
                  </div>
                  <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="downloadPdfBtn" style="display: none;">
                      <i class="fas fa-file-pdf me-1"></i> Télécharger PDF
                    </button>
                    <a href="/actes.html" class="btn btn-sm btn-outline-primary ms-2">
                      <i class="fas fa-list me-1"></i> Voir la liste
                    </a>
                  </div>
                </div>
              </div>
              <div id="error-message" class="alert alert-danger d-none" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="error-text"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/sidebar-template.js"></script>
  <script src="/js/pdfUtils.js"></script>
  <script>
    let currentStep = 1;
    const totalSteps = 4;
    
    // Variables pour le mode édition
    let isEditMode = false;
    let editActeId = null;
    
    // Vérifier si on est en mode édition
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      editActeId = urlParams.get('edit');
      
      if (editActeId) {
        isEditMode = true;
        document.getElementById('pageTitle').textContent = 'Modification d\'un Acte de Mariage - État Civil Tchad';
        document.querySelector('.form-header h2').textContent = 'Modification d\'un Acte de Mariage';
        loadActeForEdit(editActeId);
      }
      
      const token = checkAuth();
      if (!token) return;
      
      document.getElementById('common-styles').textContent = commonCSS;
      document.getElementById('sidebar-container').innerHTML = createSidebar('mariage');
      
      // Gérer la soumission du formulaire
      document.getElementById('formMariage').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
          const formData = new FormData(e.target);
          const mariageData = Object.fromEntries(formData);
          
          // Vérifier que les champs obligatoires sont présents
          const requiredFields = {
            'dateMariage': 'La date du mariage est requise',
            'lieuMariage': 'Le lieu du mariage est requis',
            'nomConjoint1': 'Le nom du conjoint 1 est requis',
            'prenomConjoint1': 'Le prénom du conjoint 1 est requis',
            'nomConjoint2': 'Le nom du conjoint 2 est requis',
            'prenomConjoint2': 'Le prénom du conjoint 2 est requis'
          };
          
          const missingFields = [];
          for (const [field, message] of Object.entries(requiredFields)) {
            if (!mariageData[field] || mariageData[field].trim() === '') {
              missingFields.push(message);
            }
          }
          
          if (missingFields.length > 0) {
            throw new Error(missingFields.join('\n'));
          }
        
        // Structurer les données selon le modèle attendu par le serveur
        const acteData = {
          type: 'mariage',
          details: {
            // Champs requis par la validation côté serveur
            dateMariage: mariageData.dateMariage,
            lieuMariage: mariageData.lieuMariage,
            conjoint1: mariageData.nomConjoint1,
            conjointe2: mariageData.nomConjoint2,
            
            // Champs supplémentaires pour le PDF
            prenomConjoint1: mariageData.prenomConjoint1 || '',
            prenomConjoint2: mariageData.prenomConjoint2 || '',
            heureMariage: mariageData.heureMariage || '12:00',
            typeCeremonie: mariageData.typeCeremonie || 'Civile',
            
            // Informations détaillées des conjoints
            conjoint1_details: {
              nom: mariageData.nomConjoint1,
              prenom: mariageData.prenomConjoint1,
              dateNaissance: mariageData.dateNaissanceConjoint1 || '',
              lieuNaissance: mariageData.lieuNaissanceConjoint1 || '',
              nationalite: mariageData.nationaliteConjoint1 || '',
              profession: mariageData.professionConjoint1 || '',
              situationAnterieure: mariageData.situationAnterieure1 || '',
              adresse: mariageData.adresseConjoint1 || '',
              pere: mariageData.pereConjoint1 || '',
              mere: mariageData.mereConjoint1 || ''
            },
            
            conjoint2_details: {
              nom: mariageData.nomConjoint2,
              prenom: mariageData.prenomConjoint2,
              dateNaissance: mariageData.dateNaissanceConjoint2 || '',
              lieuNaissance: mariageData.lieuNaissanceConjoint2 || '',
              nationalite: mariageData.nationaliteConjoint2 || '',
              profession: mariageData.professionConjoint2 || '',
              situationAnterieure: mariageData.situationAnterieure2 || '',
              adresse: mariageData.adresseConjoint2 || '',
              pere: mariageData.pereConjoint2 || '',
              mere: mariageData.mereConjoint2 || ''
            },
            
            // Témoins
            temoins: [
              {
                nom: mariageData.temoin1 || '',
                profession: mariageData.professionTemoin1 || '',
                dateNaissance: mariageData.dateNaissanceTemoin1 || '',
                residence: mariageData.residenceTemoin1 || ''
              },
              {
                nom: mariageData.temoin2 || '',
                profession: mariageData.professionTemoin2 || '',
                dateNaissance: mariageData.dateNaissanceTemoin2 || '',
                residence: mariageData.residenceTemoin2 || ''
              }
            ],
            
            // Informations complémentaires
            regimeMatrimonial: mariageData.regimeMatrimonial || 'Séparation de biens',
            contratMariage: mariageData.contratMariage || 'Non',
            observations: mariageData.observations || 'Aucune observation'
          },
          mairie: mariageData.mairie || 'Mairie de N\'Djamena'
        };
        
        // Vérifier que les champs requis sont bien définis
        if (!acteData.details.conjoint1 || !acteData.details.conjointe2) {
          throw new Error('Les noms des conjoints sont requis');
        }
        
        console.log('Données envoyées au serveur:', JSON.stringify(acteData, null, 2));
        
        // Vérification finale des champs requis dans l'objet acteData
        const requiredActeFields = ['dateMariage', 'lieuMariage', 'conjoint1', 'conjointe2'];
        const missingActeFields = requiredActeFields.filter(field => !acteData.details[field]);
        
        if (missingActeFields.length > 0) {
          console.error('Champs manquants dans l\'objet acteData:', missingActeFields);
          throw new Error(`Erreur de configuration: ${missingActeFields.join(', ')}`);
        }
        
        const url = isEditMode ? `/api/actes/${editActeId}` : '/api/actes';
        const method = isEditMode ? 'PUT' : 'POST';
        
        console.log('Envoi de la requête à:', url, 'avec la méthode:', method);
        
        const result = await apiRequest(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(acteData)
        });
        
        console.log('Réponse du serveur:', result);
        const resultDiv = document.getElementById('result');
        
        if (!result) {
          throw new Error('Aucune réponse du serveur');
        }
        
        if (result.error) {
          throw new Error(result.error);
        }
        
        // Afficher le message de succès avec bouton Retour et Télécharger PDF
        const numeroActe = result.data ? (result.data.numeroActe || 'En cours de génération') : 'En cours de génération';
        const acteId = result.data ? result.data._id : null;
        
        let successHtml = [
          '<div class="alert alert-success alert-dismissible fade show">',
          '  <div class="d-flex justify-content-between align-items-start">',
          '    <div>',
          '      <i class="fas fa-check-circle me-2"></i>',
          `      <strong>Succès!</strong> ${result.message || 'Acte enregistré avec succès.'}`,
          '      <div class="mt-2">',
          `        <strong>Numéro d\'acte:</strong> ${numeroActe}`,
          '      </div>',
          '    </div>',
          '    <div class="btn-group ms-3">'
        ];
        
        if (acteId) {
          successHtml.push(
            `      <button type="button" class="btn btn-sm btn-outline-secondary" id="downloadPdfBtn">`,
            '        <i class="fas fa-file-pdf me-1"></i> Télécharger PDF',
            '      </button>'
          );
        }
        
        successHtml.push(
          '      <a href="/actes.html" class="btn btn-sm btn-outline-primary ms-2">',
          '        <i class="fas fa-list me-1"></i> Voir la liste',
          '      </a>',
          '    </div>',
          '  </div>',
          '</div>'
        );
        
        resultDiv.innerHTML = successHtml.join('\n');
        
        // Ajouter l'événement de téléchargement si l'ID est disponible
        if (acteId) {
          const downloadBtn = document.getElementById('downloadPdfBtn');
          if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
              downloadPdf(acteId);
            });
          }
        }
        
        resultDiv.scrollIntoView({ behavior: 'smooth' });
      } catch (error) {
        console.error('Erreur lors de l\'envoi de la requête:', error);
        const resultDiv = document.getElementById('result') || document.body;
        resultDiv.innerHTML = `
          <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Erreur!</strong> ${error.message || 'Une erreur est survenue lors de l\'enregistrement.'}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
          </div>
        `;
        resultDiv.scrollIntoView({ behavior: 'smooth' });
      } finally {
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Enregistrer';
        }
      }
    });
  });
    
    // Charger les données de l'acte pour modification
    async function loadActeForEdit(id) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Session expirée. Veuillez vous reconnecter.');
          window.location.href = '/login.html';
          return;
        }
        
        const response = await fetch(`/api/actes/${id}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            populateForm(result.data);
          } else {
            alert('Erreur lors du chargement de l\'acte: ' + result.error);
          }
        } else {
          alert('Erreur lors du chargement de l\'acte');
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du chargement de l\'acte');
      }
    }
    
    // Remplir le formulaire avec les données existantes
    function populateForm(acte) {
      if (!acte) return;
      
      console.log('Données complètes reçues:', JSON.stringify(acte, null, 2));
      
      const details = acte.details || {};
      const conjoint1 = details.conjoint1_details || {};
      const conjoint2 = details.conjoint2_details || {};
      const temoins = Array.isArray(details.temoins) ? details.temoins : [];
      
      // Fonction utilitaire pour définir la valeur d'un champ avec gestion des valeurs imbriquées
      const setFieldValue = (name, ...possiblePaths) => {
        const element = document.querySelector(`[name="${name}"]`);
        if (!element) {
          console.warn(`Élément non trouvé: ${name}`);
          return false; // Retourne false si l'élément n'existe pas
        }
        
        // Parcourir tous les chemins possibles jusqu'à trouver une valeur
        for (const path of possiblePaths) {
          if (path === undefined || path === null) continue;
          
          // Si c'est une fonction, l'exécuter pour obtenir la valeur
          if (typeof path === 'function') {
            const value = path();
            if (value !== undefined && value !== null) {
              element.value = value;
              return;
            }
          } 
          // Sinon, utiliser directement la valeur
          else if (path !== undefined && path !== null) {
            element.value = path;
            return;
          }
        }
        
        // Si aucune valeur n'est trouvée, vider le champ
        element.value = '';
      };
      
      // Fonction pour formater une date (supprime l'heure si présente)
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        return dateStr.split('T')[0];
      };
      
      // Informations générales
      setFieldValue('dateMariage', formatDate(details.dateMariage));
      setFieldValue('heureMariage', details.heureMariage || '');
      setFieldValue('lieuMariage', details.lieuMariage);
      setFieldValue('mairie', acte.mairie || details.mairie);
      setFieldValue('typeCeremonie', details.typeCeremonie || 'civile');
      
      // Époux (Conjoint 1)
      setFieldValue('nomConjoint1', 
        details.conjoint1, 
        conjoint1.nom,
        details.conjoint1Nom
      );
      setFieldValue('prenomConjoint1', 
        conjoint1.prenom, 
        details.conjoint1Prenom
      );
      setFieldValue('dateNaissanceConjoint1', 
        formatDate(conjoint1.dateNaissance),
        formatDate(details.dateNaissanceConjoint1),
        formatDate(details.conjoint1DateNaissance)
      );
      setFieldValue('lieuNaissanceConjoint1', 
        conjoint1.lieuNaissance,
        details.lieuNaissanceConjoint1,
        details.conjoint1LieuNaissance
      );
      setFieldValue('professionConjoint1', 
        conjoint1.profession,
        details.professionConjoint1,
        details.conjoint1Profession
      );
      setFieldValue('adresseConjoint1', 
        conjoint1.adresse,
        details.adresseConjoint1,
        details.conjoint1Adresse
      );
      setFieldValue('nationaliteConjoint1', 
        conjoint1.nationalite,
        details.nationaliteConjoint1,
        details.conjoint1Nationalite,
        'Tchadien(ne)'
      );
      // Ces champs ne sont pas dans le formulaire HTML, donc on les commente
      // setFieldValue('typePieceConjoint1', 
      //   details.typePieceConjoint1,
      //   details.conjoint1TypePiece,
      //   'CNI'
      // );
      // setFieldValue('numeroPieceConjoint1', 
      //   details.numeroPieceConjoint1,
      //   details.conjoint1NumeroPiece
      // );
      setFieldValue('pereConjoint1', 
        conjoint1.pere,
        details.pereConjoint1
      );
      setFieldValue('mereConjoint1', 
        conjoint1.mere,
        details.mereConjoint1
      );
      
      // Épouse (Conjointe 2)
      setFieldValue('nomConjoint2', 
        details.conjointe2,
        details.conjoint2Nom,
        conjoint2.nom,
        details.conjoint2_nom
      );
      setFieldValue('prenomConjoint2', 
        conjoint2.prenom,
        details.conjoint2Prenom
      );
      setFieldValue('dateNaissanceConjoint2',  // Corrigé: dateNaissanceConjoint2 au lieu de dateNaissanceConjointe2
        formatDate(conjoint2.dateNaissance),
        formatDate(details.dateNaissanceConjointe2),
        formatDate(details.dateNaissanceConjoint2),  // Ajout du format alternatif
        formatDate(details.conjoint2DateNaissance)
      );
      setFieldValue('lieuNaissanceConjoint2',  // Corrigé: lieuNaissanceConjoint2 au lieu de lieuNaissanceConjointe2
        conjoint2.lieuNaissance,
        details.lieuNaissanceConjointe2,
        details.lieuNaissanceConjoint2,  // Ajout du format alternatif
        details.conjoint2LieuNaissance
      );
      setFieldValue('professionConjoint2',  // Corrigé: professionConjoint2 au lieu de professionConjointe2
        conjoint2.profession,
        details.professionConjointe2,
        details.professionConjoint2,  // Ajout du format alternatif
        details.conjoint2Profession
      );
      setFieldValue('adresseConjoint2',  // Corrigé: adresseConjoint2 au lieu de adresseConjointe2
        conjoint2.adresse,
        details.adresseConjointe2,
        details.adresseConjoint2,  // Ajout du format alternatif
        details.conjoint2Adresse
      );
      setFieldValue('nationaliteConjoint2',  // Corrigé: nationaliteConjoint2 au lieu de nationaliteConjointe2
        conjoint2.nationalite,
        details.nationaliteConjointe2,
        details.nationaliteConjoint2,  // Ajout du format alternatif
        details.conjoint2Nationalite,
        'Tchadien(ne)'
      );
      // Ces champs ne sont pas dans le formulaire HTML, donc on les commente
      // setFieldValue('typePieceConjoint2', 
      //   details.typePieceConjointe2,
      //   details.conjoint2TypePiece,
      //   'CNI'
      // );
      // setFieldValue('numeroPieceConjoint2', 
      //   details.numeroPieceConjointe2,
      //   details.conjoint2NumeroPiece
      // );
      setFieldValue('pereConjoint2',  // Corrigé: pereConjoint2 au lieu de pereConjointe2
        conjoint2.pere,
        details.pereConjointe2,
        details.pereConjoint2  // Ajout du format alternatif
      );
      setFieldValue('mereConjoint2',  // Corrigé: mereConjoint2 au lieu de mereConjointe2
        conjoint2.mere,
        details.mereConjointe2,
        details.mereConjoint2  // Ajout du format alternatif
      );
      
      // Mariage
      setFieldValue('dateMariage', formatDate(details.dateMariage));
      setFieldValue('lieuMariage', details.lieuMariage);
      setFieldValue('regimeMatrimonial', 
        details.regimeMatrimonial, 
        'Communauté réduite aux acquêts'
      );
      setFieldValue('contratMariage', 
        details.contratMariage, 
        'Non'
      );
      
      // Témoins - avec vérification de l'existence des champs
      const temoin1 = temoins[0] || {};
      setFieldValue('temoin1', temoin1.nom || details.temoin1 || details.temoin1Nom || '');
      // Les champs suivants n'existent pas dans le formulaire HTML, donc on les commente
      // setFieldValue('temoin1Prenom', temoin1.prenom || details.temoin1Prenom || '');
      setFieldValue('professionTemoin1', temoin1.profession || details.temoin1Profession || '');
      setFieldValue('residenceTemoin1', temoin1.adresse || details.temoin1Adresse || temoin1.residence || '');
      setFieldValue('dateNaissanceTemoin1', formatDate(temoin1.dateNaissance) || '');
      
      // Mettre à jour les valeurs des sélecteurs avec gestion des valeurs par défaut
      const setSelectValue = (name, value, defaultValue = '') => {
        const select = document.querySelector(`select[name="${name}"]`);
        if (select) {
          const finalValue = value || defaultValue;
          // Vérifier si la valeur existe dans les options
          const optionExists = Array.from(select.options).some(opt => opt.value === finalValue);
          if (optionExists) {
            select.value = finalValue;
          } else {
            console.warn(`Valeur non valide pour le sélecteur ${name}: ${finalValue}`);
            select.value = defaultValue;
          }
        }
      };
      
      // Définir les valeurs des sélecteurs
      setSelectValue('situationAnterieure1', 
        conjoint1.situationAnterieure || details.situationAnterieure1, 
        'celibataire'
      );
      
      setSelectValue('situationAnterieure2', 
        conjoint2.situationAnterieure || details.situationAnterieure2, 
        'celibataire'
      );
      
      setSelectValue('typeCeremonie', 
        (details.typeCeremonie || '').toLowerCase(), 
        'civile'
      );
      
      setSelectValue('regimeMatrimonial', 
        details.regimeMatrimonial, 
        'communauté'
      );
      
      setSelectValue('contratMariage', 
        details.contratMariage, 
        'non'
      );
      
      const temoin2 = temoins[1] || {};
      setFieldValue('temoin2', (temoin2.nom || details.temoin2 || details.temoin2Nom || ''));
      // Les champs suivants n'existent pas dans le formulaire HTML, donc on les commente
      // setFieldValue('temoin2Prenom', (temoin2.prenom || details.temoin2Prenom || ''));
      setFieldValue('professionTemoin2', (temoin2.profession || details.temoin2Profession || ''));
      setFieldValue('residenceTemoin2', (temoin2.adresse || details.temoin2Adresse || temoin2.residence || ''));
      setFieldValue('dateNaissanceTemoin2', formatDate(temoin2.dateNaissance) || '');
      
      // Informations complémentaires avec valeurs par défaut
      setFieldValue('observations', details.observations || '');
      // Le champ officierEtatCivil n'existe pas dans le formulaire HTML, donc on le commente
      // setFieldValue('officierEtatCivil', details.officierEtatCivil || '');
      
      // Afficher un message de débogage dans la console
      console.log('Formulaire rempli avec succès');
    }
    
    function changeStep(direction) {
      const newStep = currentStep + direction;
      
      if (newStep < 1 || newStep > totalSteps) return;
      
      // Validation avant de passer à l'étape suivante
      if (direction > 0 && !validateCurrentStep()) {
        return;
      }
      
      currentStep = newStep;
      showStep(currentStep);
    }
    
    function showStep(step) {
      // Masquer toutes les sections
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Afficher la section courante
      document.getElementById(`section-${step}`).classList.add('active');
      
      // Mettre à jour les indicateurs d'étapes
      document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        if (index + 1 < step) {
          stepEl.classList.add('completed');
        } else if (index + 1 === step) {
          stepEl.classList.add('active');
        }
      });
      
      // Gérer les boutons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      prevBtn.style.display = step === 1 ? 'none' : 'inline-block';
      nextBtn.style.display = step === totalSteps ? 'none' : 'inline-block';
      submitBtn.style.display = step === totalSteps ? 'inline-block' : 'none';
    }
    
    function validateCurrentStep() {
      const currentSection = document.getElementById(`section-${currentStep}`);
      const requiredFields = currentSection.querySelectorAll('[required]');
      
      for (let field of requiredFields) {
        if (!field.value.trim()) {
          field.focus();
          field.classList.add('is-invalid');
          
          // Retirer la classe après 3 secondes
          setTimeout(() => {
            field.classList.remove('is-invalid');
          }, 3000);
          
          alert(`Veuillez remplir le champ: ${field.previousElementSibling.textContent}`);
          return false;
        }
      }
      
      return true;
    }
    
    // Fonction pour télécharger le PDF
    async function downloadPdf(acteId) {
      if (!acteId) {
        showAlert('error', 'Erreur', 'Aucun acte à télécharger');
        return Promise.reject(new Error('ID d\'acte manquant'));
      }
      
      // Utiliser la fonction utilitaire pour télécharger le PDF
      return downloadActePdf('mariage', acteId, 'downloadPdfBtn')
        .catch(error => {
          console.error('Erreur lors du téléchargement du PDF:', error);
          showAlert('error', 'Erreur', error.message || 'Échec du téléchargement du PDF');
        });
    }
    
    // Validation en temps réel
    document.addEventListener('input', (e) => {
      if (e.target.hasAttribute('required') && e.target.value.trim()) {
        e.target.classList.remove('is-invalid');
      }
    });
    
    // Gestionnaire de soumission du formulaire
    document.getElementById('formMariage').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!validateCurrentStep()) return;
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';
      
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      try {
        // Récupération des données du formulaire
        const formData = new FormData(this);
        const mariageData = Object.fromEntries(formData.entries());
        const isEditMode = !!editActeId;
        
        const response = await fetch(isEditMode ? `/api/mariages/${editActeId}` : '/api/mariages', {
          method: isEditMode ? 'PUT' : 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(mariageData)
        });
        
        if (!response.ok) {
          throw new Error('Erreur lors de l\'enregistrement des données');
        }
        
        const acteId = await response.json();
        await downloadPdf(acteId);
        
      } catch (error) {
        console.error('Erreur lors de l\'enregistrement des données:', error);
        document.getElementById('error-text').textContent = 'Erreur lors de l\'enregistrement des données: ' + error.message;
        document.getElementById('error-message').classList.remove('d-none');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Enregistrer';
      }
    });
  </script>
</body>
</html>