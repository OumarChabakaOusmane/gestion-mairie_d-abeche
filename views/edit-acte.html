<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifier un Acte</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .form-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-top: 2rem;
    }
    .form-header {
      border-bottom: 2px solid #3498db;
      padding-bottom: 1rem;
      margin-bottom: 2rem;
    }
    .section-title {
      color: #2c3e50;
      border-left: 4px solid #3498db;
      padding-left: 10px;
      margin: 2rem 0 1rem;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="form-container">
          <div class="form-header">
            <h2><i class="fas fa-edit me-2"></i>Modifier un Acte</h2>
          </div>
          
          <form id="editActeForm">
            <div id="formContent">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Chargement...</span>
                </div>
                <p>Chargement des données de l'acte...</p>
              </div>
            </div>
            
            <div class="mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>Enregistrer les modifications
              </button>
              <a href="/dashboard" class="btn btn-outline-secondary ms-2">
                <i class="fas fa-times me-2"></i>Annuler
              </a>
            </div>
          </form>
          
          <div id="result" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const acteId = urlParams.get('id');
      
      if (!acteId) {
        showError('ID d\'acte non spécifié');
        return;
      }
      
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login';
          return;
        }
        
        // Charger les données de l'acte
        const response = await fetch(`/api/actes/${acteId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.message || 'Acte non trouvé');
        }
        
        if (!result.success || !result.data) {
          throw new Error('Données invalides reçues du serveur');
        }
        
        renderForm(result.data);
        setupFormSubmit(acteId, result.data.type);
      } catch (err) {
        showError(err.message);
      }
    });
    
    function renderForm(acte) {
      let formFields = '';
      
      switch(acte.type) {
        case 'naissance':
          formFields = `
            <input type="hidden" name="type" value="naissance">
            
            <h5 class="section-title">Informations sur l'enfant</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nom</label>
                <input type="text" name="nom" class="form-control" value="${acte.details.nom}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Prénom</label>
                <input type="text" name="prenom" class="form-control" value="${acte.details.prenom}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Sexe</label>
                <select class="form-select" name="sexe" required>
                  <option value="M" ${acte.details.sexe === 'M' ? 'selected' : ''}>Masculin</option>
                  <option value="F" ${acte.details.sexe === 'F' ? 'selected' : ''}>Féminin</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date de naissance</label>
                <input type="date" name="dateNaissance" class="form-control" 
                       value="${acte.details.dateNaissance}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Heure de naissance</label>
                <input type="time" name="heureNaissance" class="form-control" 
                       value="${acte.details.heureNaissance || ''}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Lieu de naissance</label>
                <input type="text" name="lieuNaissance" class="form-control" 
                       value="${acte.details.lieuNaissance}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Adresse</label>
                <input type="text" name="adresse" class="form-control" 
                       value="${acte.details.adresse}" required>
              </div>
            </div>
            
            <h5 class="section-title">Informations sur le père</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nom</label>
                <input type="text" name="pere" class="form-control" 
                       value="${acte.details.pere}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Prénom</label>
                <input type="text" name="prenomPere" class="form-control" 
                       value="${acte.details.prenomPere}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date de naissance</label>
                <input type="date" name="dateNaissancePere" class="form-control" 
                       value="${acte.details.dateNaissancePere}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Lieu de naissance</label>
                <input type="text" name="lieuNaissancePere" class="form-control" 
                       value="${acte.details.lieuNaissancePere}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Profession</label>
                <input type="text" name="professionPere" class="form-control" 
                       value="${acte.details.professionPere}" required>
              </div>
            </div>
            
            <h5 class="section-title">Informations sur la mère</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nom</label>
                <input type="text" name="mere" class="form-control" 
                       value="${acte.details.mere}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Prénom</label>
                <input type="text" name="prenomMere" class="form-control" 
                       value="${acte.details.prenomMere}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date de naissance</label>
                <input type="date" name="dateNaissanceMere" class="form-control" 
                       value="${acte.details.dateNaissanceMere}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Lieu de naissance</label>
                <input type="text" name="lieuNaissanceMere" class="form-control" 
                       value="${acte.details.lieuNaissanceMere}" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Profession</label>
                <input type="text" name="professionMere" class="form-control" 
                       value="${acte.details.professionMere}" required>
              </div>
            </div>
          `;
          break;
          
        case 'mariage':
          formFields = `
            <input type="hidden" name="type" value="mariage">
            
            <h5 class="section-title">Informations sur le mariage</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Conjoint 1</label>
                <input type="text" name="conjoint1" class="form-control" 
                       value="${acte.details.conjoint1}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Conjoint 2</label>
                <input type="text" name="conjoint2" class="form-control" 
                       value="${acte.details.conjoint2}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Date du mariage</label>
                <input type="date" name="dateMariage" class="form-control" 
                       value="${acte.details.dateMariage}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Lieu du mariage</label>
                <input type="text" name="lieuMariage" class="form-control" 
                       value="${acte.details.lieuMariage}" required>
              </div>
            </div>
          `;
          break;
          
        case 'deces':
          formFields = `
            <input type="hidden" name="type" value="deces">
            
            <h5 class="section-title">Informations sur le décès</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nom</label>
                <input type="text" name="nom" class="form-control" 
                       value="${acte.details.nom}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Prénom</label>
                <input type="text" name="prenom" class="form-control" 
                       value="${acte.details.prenom}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Date du décès</label>
                <input type="date" name="dateDeces" class="form-control" 
                       value="${acte.details.dateDeces}" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Lieu du décès</label>
                <input type="text" name="lieuDeces" class="form-control" 
                       value="${acte.details.lieuDeces}" required>
              </div>
              <div class="col-12">
                <label class="form-label">Cause du décès</label>
                <textarea name="cause" class="form-control">${acte.details.cause || ''}</textarea>
              </div>
            </div>
          `;
          break;
      }
      
      // Ajouter le champ mairie commun à tous les types
      formFields += `
        <div class="row g-3 mt-3">
          <div class="col-12">
            <label class="form-label">Mairie</label>
            <input type="text" name="mairie" class="form-control" 
                   value="${acte.mairie}" required>
          </div>
        </div>
      `;
      
      document.getElementById('formContent').innerHTML = formFields;
    }
    
    function setupFormSubmit(acteId, acteType) {
      document.getElementById('editActeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login';
          return;
        }
        
        const form = document.getElementById('editActeForm');
        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        
        // Désactiver le bouton et afficher un indicateur de chargement
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enregistrement...';
        
        try {
          const formData = new FormData(form);
          const details = Object.fromEntries(formData);
          const mairie = formData.get('mairie');
          
          const response = await fetch(`/api/actes/${acteId}`, {
            method: 'PUT',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ 
              type: acteType,
              details, 
              mairie 
            })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            showResult('success', result.message || 'Acte mis à jour avec succès');
            // Rediriger vers le tableau de bord après 2 secondes
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 2000);
          } else {
            throw new Error(result.message || 'Erreur lors de la mise à jour');
          }
        } catch (err) {
          console.error('Erreur lors de la mise à jour de l\'acte:', err);
          showResult('danger', err.message || 'Une erreur est survenue lors de la mise à jour');
        } finally {
          // Réactiver le bouton
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
          }
        }
      });
    }
    
    function showError(message) {
      document.getElementById('formContent').innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          ${message}
        </div>
        <a href="/dashboard" class="btn btn-primary mt-3">
          <i class="fas fa-arrow-left me-2"></i> Retour au tableau de bord
        </a>
      `;
    }
    
    function showResult(type, message) {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = `
        <div class="alert alert-${type}">
          <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
          ${message}
        </div>
      `;
      
      if (type === 'success') {
        setTimeout(() => {
          window.location.href = '/dashboard';
        }, 2000);
      }
    }
  </script>
</body>
</html>