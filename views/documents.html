<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documents - État Civil Tchad</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style id="common-styles"></style>
  <style>
    .document-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: box-shadow 0.3s;
    }
    .document-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .document-icon {
      font-size: 2rem;
      color: #6c757d;
    }
  </style>
</head>
<body>
  <div id="sidebar-container"></div>
  
  <div class="main-content">
    <h2 class="mb-4"><i class="fas fa-file me-2"></i> Gestion des Documents</h2>
    
    <div class="d-flex justify-content-between mb-3">
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="fas fa-upload me-2"></i>Uploader un document
      </button>
      <div class="input-group" style="width: 300px;">
        <input type="text" class="form-control" placeholder="Rechercher..." id="searchDocuments">
        <button class="btn btn-outline-secondary" type="button">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
    
    <div id="documentsList">
      <div class="text-center py-4">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Chargement...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal d'upload -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Uploader un document</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="uploadForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label">Titre du document</label>
              <input type="text" class="form-control" name="title" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Type de document</label>
              <select class="form-select" name="type" required>
                <option value="naissance">Naissance</option>
                <option value="mariage">Mariage</option>
                <option value="deces">Décès</option>
                <option value="autre">Autre</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Fichier (PDF, JPG, PNG, TXT - Max 10MB)</label>
              <input type="file" class="form-control" name="document" accept=".pdf,.jpg,.jpeg,.png,.txt" required>
            </div>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-upload me-2"></i>Uploader
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/sidebar-template.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = checkAuth();
      if (!token) return;
      
      document.getElementById('common-styles').textContent = commonCSS;
      document.getElementById('sidebar-container').innerHTML = createSidebar('documents');
      
      // Charger les documents
      await loadDocuments();
      
      // Gérer l'upload
      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        
        try {
          const response = await fetch('/api/documents', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('Document uploadé avec succès!');
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            e.target.reset();
            await loadDocuments();
          } else {
            alert(result.error || 'Erreur lors de l\'upload');
          }
        } catch (error) {
          alert('Erreur de connexion');
        }
      });
    });
    
    async function loadDocuments() {
      try {
        const result = await apiRequest('/api/documents');
        if (result && result.success) {
          displayDocuments(result.data);
        }
      } catch (error) {
        document.getElementById('documentsList').innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            Erreur lors du chargement des documents
          </div>
        `;
      }
    }
    
    function displayDocuments(documents) {
      const container = document.getElementById('documentsList');
      
      if (documents.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Aucun document trouvé</h5>
            <p class="text-muted">Commencez par uploader votre premier document</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = documents.map(doc => `
        <div class="document-card">
          <div class="row align-items-center">
            <div class="col-auto">
              <i class="fas ${getDocumentIcon(doc.mimeType)} document-icon"></i>
            </div>
            <div class="col">
              <h6 class="mb-1">${doc.title}</h6>
              <small class="text-muted">
                Type: ${doc.type} • Taille: ${formatFileSize(doc.size)} • 
                Uploadé le ${new Date(doc.uploadDate).toLocaleDateString('fr-FR')}
              </small>
            </div>
            <div class="col-auto">
              <a href="/api/documents/${doc._id}/download" class="btn btn-sm btn-outline-primary me-2">
                <i class="fas fa-download"></i>
              </a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument('${doc._id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function getDocumentIcon(mimeType) {
      if (mimeType.includes('pdf')) return 'fa-file-pdf';
      if (mimeType.includes('image')) return 'fa-file-image';
      if (mimeType.includes('text')) return 'fa-file-alt';
      return 'fa-file';
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    async function deleteDocument(id) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer ce document?')) return;
      
      const result = await apiRequest(`/api/documents/${id}`, {
        method: 'DELETE'
      });
      
      if (result) {
        alert('Document supprimé avec succès!');
        await loadDocuments();
      }
    }
  </script>
</body>
</html>